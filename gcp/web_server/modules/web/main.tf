data "google_compute_image" "web_ubuntu" {
  // this image was generated by us via packer
  name = var.web_image
}

resource "google_compute_address" "static" {
  name = "ipv4-address"
}

resource "google_compute_instance" "sandy-web" {
  name         = var.web_name
  machine_type = var.web_machine_type
  zone         = var.web_zone
  hostname     = "${var.web_name}.${var.web_domain}"
  tags         = ["ssh", "http"]

  metadata = {
    serial-port-enable     = true
    block-project-ssh-keys = false
    ssh-keys               = var.web_ssh_key
  }

  boot_disk {
    auto_delete = true
    mode        = "READ_WRITE"

    initialize_params {
      image = data.google_compute_image.web_ubuntu.self_link
    }
  }

  metadata_startup_script = "sudo apt-get update; sudo apt-get install -yq build-essential apache2"

  network_interface {
    network = var.network_01_name
    // The private IP address to assign to the instance. 
    network_ip = var.web_ip
    // The name or self_link of the subnetwork to attach this interface to.
    subnetwork = var.web_subnet_id

    access_config {
    }
  }

  scheduling {
    preemptible       = false
    automatic_restart = false
  }

  /*
  provisioner "file" {
    source      = "files/setup_joey.sh"
    destination = "/tmp/setup_joey.sh"

    connection {
      type     = "ssh"
      user     = "ubuntu"
      password = "ubuntu"
      host     = "${var.host}"
    }

  }

  provisioner "remote-exec" {
    inline = [
      "chmod +x /tmp/setup_joey.sh",
      "sudo /tmp/setup_joey.sh",
    ]
  }
  */
}

/* Create web server #2
resource "google_compute_instance" "web_private_2" {
  name         = "${var.app_name}-vm2"
  machine_type = "f1-micro"
  zone         = var.gcp_zone_1
  hostname     = "${var.app_name}-vm2.${var.app_domain}"
  tags         = ["ssh", "http"]
  boot_disk {
    initialize_params {
      image = "ubuntu-os-cloud/ubuntu-1804-lts"
    }
  }

  metadata_startup_script = "sudo apt-get update; sudo apt-get install -yq build-essential apache2"
  network_interface {
    network    = google_compute_network.vpc.name
    subnetwork = google_compute_subnetwork.private_subnet_1.name
  }
}
*/

/**
 *  Copyright 2019 Palo Alto Networks.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
